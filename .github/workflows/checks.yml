name: Checks

on:
    push:
        branches: [main]

jobs:
    checks:
        runs-on: ubuntu-latest
        concurrency:
            group: checks-${{ github.ref }}
            cancel-in-progress: true
        steps:
            - uses: actions/checkout@v6
              with:
                  fetch-depth: 0 # Fetch full history for gitleaks
            - uses: actions/setup-node@v6
              with:
                  node-version: 20
                  cache: "npm"
            - name: Install dependencies
              run: npm ci
            - name: Security audit (high+)
              run: |
                  set -e
                  npm audit --production --audit-level=high
            - name: Run Gitleaks secret scan
              uses: gitleaks/gitleaks-action@v2
            - name: ESLint
              run: npm run lint
            - name: TypeScript typecheck
              run: npx tsc --noEmit
            - name: Run tests with coverage
              env:
                  FIRESTORE_EMULATOR_HOST: 127.0.0.1:8080
              run: |
                  # Ensure coverage directory exists
                  mkdir -p coverage
                  # Run tests with coverage and JSON output
                  # --json outputs JSON array to stdout, coverage files are still generated normally
                  # Capture JSON to file, let stderr go to console for debugging
                  npm run test:coverage -- --json > coverage/test-results.json; TEST_EXIT_CODE=$?
                  # Always exit with the test result code (fail CI if tests fail)
                  exit $TEST_EXIT_CODE
            - name: Upload coverage to Codecov
              uses: codecov/codecov-action@v5
              with:
                  token: ${{ secrets.CODECOV_TOKEN }}
                  files: ./coverage/lcov.info
                  flags: unittests
                  fail_ci_if_error: true
            - name: Upload coverage artifact
              uses: actions/upload-artifact@v6
              with:
                  name: jest-coverage
                  path: coverage
            - name: Generate Job Summary
              uses: actions/github-script@v8
              with:
                  script: |
                      const fs = require('fs');
                      const path = require('path');

                      // Read coverage summary
                      let coverageSummary = 'N/A';
                      let coveragePercent = 'N/A';
                      let coverageStatus = '‚ùå';

                      try {
                          const coverageFile = 'coverage/coverage-summary.json';
                          if (fs.existsSync(coverageFile)) {
                              const coverage = JSON.parse(fs.readFileSync(coverageFile, 'utf8'));
                              if (coverage && coverage.total) {
                                  const total = coverage.total;
                                  coveragePercent = `${total.lines.pct}%`;
                                  coverageStatus = total.lines.pct >= 95 ? '‚úÖ' : '‚ùå';
                                  coverageSummary = `Lines: ${total.lines.pct}% | Functions: ${total.functions.pct}% | Branches: ${total.branches.pct}% | Statements: ${total.statements.pct}%`;
                              } else {
                                  console.log('Coverage file exists but missing total field');
                              }
                          } else {
                              console.log(`Coverage file not found at: ${coverageFile}`);
                              // List files in coverage directory for debugging
                              try {
                                  const coverageDir = 'coverage';
                                  if (fs.existsSync(coverageDir)) {
                                      const files = fs.readdirSync(coverageDir);
                                      console.log(`Files in coverage directory: ${files.join(', ')}`);
                                  }
                              } catch (dirErr) {
                                  console.log('Could not list coverage directory:', dirErr.message);
                              }
                          }
                      } catch (e) {
                          console.log('Could not read coverage summary:', e.message);
                          console.log('Error stack:', e.stack);
                      }

                      // Read test results
                      let testSummary = 'N/A';
                      let testStatus = '‚ùå';

                      try {
                          const testFile = 'coverage/test-results.json';
                          if (fs.existsSync(testFile)) {
                              const testResults = JSON.parse(fs.readFileSync(testFile, 'utf8'));
                              // Jest --json outputs an array of test suite results
                              // Aggregate results from all test suites
                              let numTotalTests = 0;
                              let numPassedTests = 0;
                              let numFailedTests = 0;
                              
                              if (Array.isArray(testResults)) {
                                  testResults.forEach(suite => {
                                      numTotalTests += suite.numTotalTests || 0;
                                      numPassedTests += suite.numPassedTests || 0;
                                      numFailedTests += suite.numFailedTests || 0;
                                  });
                              } else if (testResults.numTotalTests !== undefined) {
                                  // Fallback: if it's already a summary object
                                  numTotalTests = testResults.numTotalTests;
                                  numPassedTests = testResults.numPassedTests;
                                  numFailedTests = testResults.numFailedTests;
                              }
                              
                              if (numTotalTests > 0) {
                                  testSummary = `${numPassedTests}/${numTotalTests} passed`;
                                  testStatus = numFailedTests === 0 ? '‚úÖ' : '‚ùå';
                              } else {
                                  testSummary = 'No tests found';
                                  testStatus = '‚ö†Ô∏è';
                              }
                          } else {
                              console.log(`Test results file not found at: ${testFile}`);
                          }
                      } catch (e) {
                          console.log('Could not read test results:', e.message);
                          console.log('Error stack:', e.stack);
                          testSummary = 'See logs for details';
                      }

                      // Check Gitleaks results
                      let gitleaksStatus = '‚úÖ';
                      let gitleaksSummary = 'No secrets found';

                      try {
                          // Check if Gitleaks found any leaks by looking at the job context
                          // This is a simplified check - in practice, Gitleaks action handles this
                          gitleaksStatus = '‚úÖ';
                          gitleaksSummary = 'No secrets detected (excluded false positives)';
                      } catch (e) {
                          gitleaksStatus = '‚ùå';
                          gitleaksSummary = 'Secrets detected - check logs';
                      }

                      // Get artifact URLs (with error handling)
                      let coverageUrl = 'Not available';
                      try {
                          const artifacts = await github.rest.actions.listWorkflowRunArtifacts({
                              owner: context.repo.owner,
                              repo: context.repo.repo,
                              run_id: context.runId
                          });

                          const coverageArtifact = artifacts.data.artifacts.find(a => a.name === 'jest-coverage');
                          if (coverageArtifact) {
                              coverageUrl = `[Download Coverage Report](${coverageArtifact.archive_download_url})`;
                          } else {
                              // Fallback: link to workflow run artifacts page
                              coverageUrl = `[View Artifacts](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})`;
                          }
                      } catch (e) {
                          console.log('Could not fetch artifacts (may not be available yet):', e.message);
                          // Fallback: link to workflow run artifacts page
                          coverageUrl = `[View Artifacts](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})`;
                      }

                      // Create summary
                      const summary = `# üîç Quality Checks Summary

                      ## Status Overview
                      | Check | Status | Details |
                      |-------|--------|---------|
                      | **Lint** | ‚úÖ | ESLint passed |
                      | **TypeCheck** | ‚úÖ | TypeScript compilation successful |
                      | **Tests** | ${testStatus} | ${testSummary} |
                      | **Coverage** | ${coverageStatus} | ${coverageSummary} |
                      | **Security Audit** | ‚úÖ | npm audit passed (high+ vulnerabilities) |
                      | **Secret Scan** | ${gitleaksStatus} | ${gitleaksSummary} |

                      ## Coverage Details
                      - **Threshold**: 95% (${coverageStatus === '‚úÖ' ? 'PASSED' : 'FAILED'})
                      - **Current**: ${coveragePercent}
                      - **Report**: ${coverageUrl}

                      ## Security Checks
                      - ‚úÖ **npm audit**: No high+ severity vulnerabilities found
                      - ${gitleaksStatus} **Gitleaks**: ${gitleaksSummary}

                      ## Artifacts
                      - üìä **Coverage Report**: ${coverageUrl}

                      ---
                      *Generated by GitHub Actions*`;

                      // Only create issue comment if this is a PR
                      if (context.payload.pull_request || context.issue?.number) {
                          try {
                              await github.rest.issues.createComment({
                                  issue_number: context.issue.number || context.payload.pull_request.number,
                                  owner: context.repo.owner,
                                  repo: context.repo.repo,
                                  body: summary
                              });
                          } catch (e) {
                              console.log('Could not create issue comment:', e.message);
                              console.log('Job Summary:', summary);
                          }
                      } else {
                          // For push events, just log the summary
                          console.log('Job Summary:', summary);
                      }

                      // Also set as job summary
                      core.summary
                          .addHeading('Quality Checks Summary')
                          .addRaw('\n')
                          .addTable([
                              [{data: 'Check', header: true}, {data: 'Status', header: true}, {data: 'Details', header: true}],
                              ['Lint', '‚úÖ', 'ESLint passed'],
                              ['TypeCheck', '‚úÖ', 'TypeScript compilation successful'],
                              ['Tests', testStatus, testSummary],
                              ['Coverage', coverageStatus, coverageSummary],
                              ['Security Audit', '‚úÖ', 'npm audit passed (high+ vulnerabilities)'],
                              ['Secret Scan', gitleaksStatus, gitleaksSummary]
                          ])
                          .addRaw('\n')
                          .addHeading('Coverage Details', 2)
                          .addRaw('\n')
                          .addRaw(`- **Threshold**: 95% (${coverageStatus === '‚úÖ' ? 'PASSED' : 'FAILED'})\n`)
                          .addRaw(`- **Current**: ${coveragePercent}\n`)
                          .addRaw(`- **Report**: ${coverageUrl}\n`)
                          .addHeading('Security Checks', 2)
                          .addRaw('\n')
                          .addRaw(`- ‚úÖ **npm audit**: No high+ severity vulnerabilities found\n`)
                          .addRaw(`- ${gitleaksStatus} **Gitleaks**: ${gitleaksSummary}\n`)
                          .addHeading('Artifacts', 2)
                          .addRaw('\n')
                          .addRaw(`- üìä **Coverage Report**: ${coverageUrl}\n`)
                          .write();

                      // Optional: Email notification on failure (commented out)
                      /*
                      // Uncomment to enable email notifications on failure
                      if (context.job === 'checks' && context.payload.action === 'completed' && context.payload.workflow_run.conclusion === 'failure') {
                          const emailSummary = `# ‚ùå Quality Checks Failed
                          
                          ## Failed Checks
                          - Repository: ${context.repo.owner}/${context.repo.repo}
                          - Branch: ${context.payload.head_branch || 'main'}
                          - Workflow: ${context.workflow}
                          - Run ID: ${context.runId}
                          - Commit: ${context.sha}
                          
                          ## Next Steps
                          1. Check the [workflow logs](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})
                          2. Fix the failing checks
                          3. Push a new commit to retry
                          
                          ---
                          *This is an automated notification from GitHub Actions*`;
                          
                          // Add to job summary for visibility
                          core.summary
                              .addHeading('‚ùå Failure Notification', 1)
                              .addRaw(emailSummary)
                              .write();
                      }
                      */
