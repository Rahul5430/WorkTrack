name: Android Build

on:
    workflow_run:
        workflows: ['Checks']
        types: [completed]

jobs:
    build-android:
        if: ${{ github.event.workflow_run.conclusion == 'success' }}
        runs-on: macos-15
        steps:
            - uses: actions/checkout@v4
            - uses: actions/setup-node@v4
              with:
                  node-version: 20
                  cache: 'npm'
            - name: Setup Java 17
              uses: actions/setup-java@v4
              with:
                  distribution: 'temurin'
                  java-version: '17'
            - name: Setup Android SDK
              uses: android-actions/setup-android@v3
            - name: Install Node dependencies
              run: npm ci
            - name: Build Android debug APK
              run: |
                  cd android
                  echo "Gradle version:"
                  ./gradlew --version
                  echo "Building APK..."
                  ./gradlew assembleDebug --info
            - name: Show APK files
              run: |
                  echo "Checking for APK files..."
                  find android/app/build/outputs -name "*.apk" -type f
                  ls -la android/app/build/outputs/apk/debug/ || echo "Debug directory not found"
                  ls -la android/app/build/outputs/ || echo "Outputs directory not found"
            - name: Upload Android debug APK
              uses: actions/upload-artifact@v4
              with:
                  name: android-debug-apk
                  path: |
                      android/app/build/outputs/apk/debug/app-debug.apk
                      android/app/build/outputs/apk/debug/output-metadata.json
                  if-no-files-found: error

            - name: Upload APK to Release (latest)
              if: ${{ github.ref == 'refs/heads/main' }}
              uses: softprops/action-gh-release@v2
              with:
                  tag_name: android-debug-latest
                  name: Android Debug Latest
                  draft: false
                  prerelease: false
                  files: |
                      android/app/build/outputs/apk/debug/app-debug.apk
                      android/app/build/outputs/apk/debug/output-metadata.json
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
