name: Android Build

on:
    workflow_run:
        workflows: ['Checks']
        types: [completed]
    push:
        branches: [main]
        paths:
            - 'android/**'
            - 'src/**'
            - 'package.json'
            - 'package-lock.json'
            - 'metro.config.js'
            - 'babel.config.js'
            - 'tsconfig.json'
            - 'jest.config.js'
    pull_request:
        branches: [main]
        paths:
            - 'android/**'
            - 'src/**'
            - 'package.json'
            - 'package-lock.json'
            - 'metro.config.js'
            - 'babel.config.js'
            - 'tsconfig.json'
            - 'jest.config.js'

permissions:
    contents: write

jobs:
    build-android:
        if: ${{ github.event.workflow_run.conclusion == 'success' }}
        runs-on: macos-15
        concurrency:
            group: android-${{ github.event.workflow_run.head_branch || github.ref }}
            cancel-in-progress: true
        steps:
            - uses: actions/checkout@v4
            - uses: actions/setup-node@v4
              with:
                  node-version: 20
                  cache: 'npm'
            - name: Setup Java 17
              uses: actions/setup-java@v4
              with:
                  distribution: 'temurin'
                  java-version: '17'
            - name: Setup Android SDK
              uses: android-actions/setup-android@v3
            - name: Setup Gradle Build Action
              uses: gradle/gradle-build-action@v3
              with:
                  gradle-version: wrapper
                  cache-read-only: false
            - name: Cache Metro bundler
              uses: actions/cache@v4
              with:
                  path: |
                      ~/.cache/metro
                      node_modules/.cache
                  key: ${{ runner.os }}-metro-${{ hashFiles('package-lock.json', 'metro.config.js', 'babel.config.js') }}
                  restore-keys: |
                      ${{ runner.os }}-metro-
            - name: Download node_modules from Checks
              uses: actions/download-artifact@v4
              with:
                  name: node-modules
                  path: .
            - name: Verify node_modules
              run: |
                  if [ ! -d "node_modules" ]; then
                      echo "node_modules not found, falling back to npm ci"
                      npm ci
                  else
                      echo "Using cached node_modules from Checks workflow"
                      ls -la node_modules | head -10
                  fi
            - name: Build Android debug APK
              run: |
                  cd android
                  echo "Gradle version:"
                  ./gradlew --version
                  echo "Building APK with CI optimizations..."
                  ./gradlew assembleDebug --info --parallel --build-cache -Dorg.gradle.caching=true -Dorg.gradle.parallel=true -Dorg.gradle.configureondemand=true
            - name: Show APK files
              run: |
                  echo "Checking for APK files..."
                  find android/app/build/outputs -name "*.apk" -type f
                  ls -la android/app/build/outputs/apk/debug/ || echo "Debug directory not found"
                  ls -la android/app/build/outputs/ || echo "Outputs directory not found"
            - name: Upload Android debug APK
              uses: actions/upload-artifact@v4
              with:
                  name: android-debug-apk
                  path: |
                      android/app/build/outputs/apk/debug/app-debug.apk
                      android/app/build/outputs/apk/debug/output-metadata.json
                  if-no-files-found: error

            - name: Upload APK to Release (latest)
              if: ${{ github.event.workflow_run.head_branch == 'main' }}
              uses: softprops/action-gh-release@v2
              with:
                  tag_name: android-debug-latest
                  name: Android Debug Latest
                  draft: false
                  prerelease: false
                  files: |
                      android/app/build/outputs/apk/debug/app-debug.apk
                      android/app/build/outputs/apk/debug/output-metadata.json
                  token: ${{ github.token }}
