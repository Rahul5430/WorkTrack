name: "CodeQL"

on:
    push:
        branches: [main]
    pull_request:
        branches: [main]
    schedule:
        # Run weekly on Monday at 2:00 UTC
        - cron: "0 2 * * 1"

jobs:
    analyze:
        name: Analyze
        runs-on: ${{ matrix.runner }}
        permissions:
            actions: read
            contents: read
            security-events: write

        strategy:
            fail-fast: false
            matrix:
                include:
                    - language: "javascript"
                      runner: "ubuntu-latest"
                    - language: "typescript"
                      runner: "ubuntu-latest"
                    - language: "kotlin"
                      runner: "ubuntu-latest"
                    - language: "swift"
                      runner: "macos-15"

        steps:
            - name: Checkout repository
              uses: actions/checkout@v6

            - name: Initialize CodeQL
              uses: github/codeql-action/init@v3
              with:
                  languages: ${{ matrix.language }}
                  config-file: .github/codeql/codeql-config.yml
                  # Use the latest CodeQL bundle
                  tools: latest

            # Autobuild for JavaScript/TypeScript (optional - CodeQL can analyze source directly)
            - name: Autobuild (JavaScript/TypeScript)
              if: matrix.language == 'javascript' || matrix.language == 'typescript'
              uses: github/codeql-action/autobuild@v3

            # Setup for Kotlin (Android) - minimal setup for dependency resolution
            - name: Setup Java for Kotlin
              if: matrix.language == 'kotlin'
              uses: actions/setup-java@v4
              with:
                  distribution: "temurin"
                  java-version: "17"
                  cache: "gradle"

            - name: Autobuild (Kotlin)
              if: matrix.language == 'kotlin'
              uses: github/codeql-action/autobuild@v3

            # Setup for Swift (iOS) - CodeQL needs Xcode for Swift analysis
            - name: Setup Xcode for Swift
              if: matrix.language == 'swift'
              uses: maxim-lobanov/setup-xcode@v1
              with:
                  xcode-version: "26.0"

            - name: Autobuild (Swift)
              if: matrix.language == 'swift'
              uses: github/codeql-action/autobuild@v3

            - name: Perform CodeQL Analysis
              uses: github/codeql-action/analyze@v3
              with:
                  category: "/language:${{ matrix.language }}"
